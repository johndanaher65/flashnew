<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fish Flash - –ü–æ–∫–µ—Ä –∫–ª—É–±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 30px;
      padding: 40px 30px;
      max-width: 450px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* –õ–æ–≥–æ—Ç–∏–ø */
    .logo-container {
      margin-bottom: 25px;
      animation: fadeInDown 0.8s ease-out;
    }

    .logo {
      width: 180px;
      height: 180px;
      margin: 0 auto;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(94, 172, 255, 0.3);
    }

    .logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
    .title {
      font-size: 42px;
      font-weight: 800;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #5eacff 0%, #a78bfa 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: fadeInUp 0.8s ease-out 0.2s both;
    }

    .subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 30px;
      animation: fadeInUp 0.8s ease-out 0.3s both;
    }

    /* –†–µ–π—Ç–∏–Ω–≥ */
    .rating-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 30px;
      animation: fadeInUp 0.8s ease-out 0.4s both;
    }

    .stars {
      display: flex;
      gap: 5px;
    }

    .star {
      color: #ffd700;
      font-size: 24px;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .rating-text {
      color: rgba(255, 255, 255, 0.9);
      font-size: 18px;
      font-weight: 600;
    }

    /* –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ */
    .features {
      display: grid;
      gap: 15px;
      margin-bottom: 35px;
      animation: fadeInUp 0.8s ease-out 0.5s both;
    }

    .feature {
      background: rgba(94, 172, 255, 0.1);
      border: 1px solid rgba(94, 172, 255, 0.3);
      border-radius: 15px;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .feature:hover {
      background: rgba(94, 172, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(94, 172, 255, 0.2);
    }

    .feature-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .feature-text {
      color: rgba(255, 255, 255, 0.9);
      font-size: 15px;
      text-align: left;
      font-weight: 500;
    }

    /* –ö–Ω–æ–ø–∫–∞ */
    .cta-button {
      background: linear-gradient(135deg, #5eacff 0%, #a78bfa 100%);
      border: none;
      color: white;
      font-size: 20px;
      font-weight: 700;
      padding: 18px 50px;
      border-radius: 50px;
      cursor: pointer;
      width: 100%;
      box-shadow: 0 15px 40px rgba(94, 172, 255, 0.4);
      transition: all 0.3s ease;
      animation: fadeInUp 0.8s ease-out 0.6s both, pulse 2s ease-in-out infinite;
      text-decoration: none;
      display: inline-block;
    }

    .cta-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 50px rgba(94, 172, 255, 0.6);
    }

    .cta-button:active {
      transform: translateY(-1px);
    }

    .loading {
      margin-top: 20px;
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 15px 40px rgba(94, 172, 255, 0.4);
      }
      50% {
        box-shadow: 0 15px 50px rgba(94, 172, 255, 0.6);
      }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 480px) {
      .container {
        padding: 30px 20px;
      }

      .logo {
        width: 150px;
        height: 150px;
      }

      .title {
        font-size: 36px;
      }

      .subtitle {
        font-size: 14px;
      }

      .rating-text {
        font-size: 16px;
      }

      .star {
        font-size: 20px;
      }

      .feature-text {
        font-size: 14px;
      }

      .cta-button {
        font-size: 18px;
        padding: 16px 40px;
      }
    }
  </style>
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  // –û–¢–ö–õ–Æ–ß–ê–ï–ú –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è (Lead, Purchase –∏ —Ç.–¥.)
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä—É—á–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (PageView, –∫–∞—Å—Ç–æ–º–Ω—ã–µ)
  fbq('init', '1423126186111427', {
    autoConfig: false,  // –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-–¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π
    disablePushState: true  // –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ-—Ç—Ä–µ–∫–∏–Ω–≥ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  });
  fbq('track', 'PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
  src="https://www.facebook.com/tr?id=1423126186111427&ev=PageView&noscript=1"
  /></noscript>
</head>
<body>
  <div class="container">
    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <div class="logo-container">
      <div class="logo">
        <img src="fishflash.jpg" alt="Fish Flash">
      </div>
    </div>

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <h1 class="title">FISH FLASH</h1>
    <p class="subtitle">–õ—É—á—à–∏–π –ø–æ–∫–µ—Ä –∫–ª—É–±</p>

    <!-- –†–µ–π—Ç–∏–Ω–≥ -->
    <div class="rating-container">
      <div class="stars">
        <span class="star">‚òÖ</span>
        <span class="star">‚òÖ</span>
        <span class="star">‚òÖ</span>
        <span class="star">‚òÖ</span>
        <span class="star">‚òÖ</span>
      </div>
      <span class="rating-text">5.0</span>
    </div>

    <!-- –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ -->
    <div class="features">
      <div class="feature">
        <div class="feature-icon">üé∞</div>
        <div class="feature-text">–ë—ã—Å—Ç—Ä—ã–µ –∏–≥—Ä—ã –∏ –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã</div>
      </div>

      <div class="feature">
        <div class="feature-icon">üèÜ</div>
        <div class="feature-text">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ç—É—Ä–Ω–∏—Ä—ã –∏ –∞–∫—Ü–∏–∏</div>
      </div>

      <div class="feature">
        <div class="feature-icon">üí¨</div>
        <div class="feature-text">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ 24/7 –≤ Telegram</div>
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ -->
    <a id="telegramButton" class="cta-button" href="#" target="_blank" rel="noopener noreferrer">
      üéÆ –ù–ê–ß–ê–¢–¨ –ò–ì–†–ê–¢–¨
    </a>
    <div id="loading" class="loading" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <script>
  // ========================================
  // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –°–ë–û–†–ê –î–ê–ù–ù–´–• –î–õ–Ø EMQ
  // ========================================

  /**
   * –ü–æ–ª—É—á–∏—Ç—å Facebook Browser Pixel cookie (_fbp)
   * Facebook Pixel —Å–æ–∑–¥–∞–µ—Ç —ç—Ç–æ—Ç cookie –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   * –§–æ—Ä–º–∞—Ç: fb.2.{timestamp}.{random_id}
   */
  function getFacebookBrowserPixel() {
    const cookies = document.cookie.split('; ');
    for (let cookie of cookies) {
      if (cookie.startsWith('_fbp=')) {
        return cookie.substring(5);
      }
    }

    // –ï—Å–ª–∏ _fbp –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID –±—Ä–∞—É–∑–µ—Ä–∞
    const timestamp = Date.now();
    const randomId = Math.random().toString().substring(2) + Math.random().toString().substring(2);
    const fbp = `fb.2.${timestamp}.${randomId}`;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º cookie –Ω–∞ 90 –¥–Ω–µ–π (—Å—Ç–∞–Ω–¥–∞—Ä—Ç Facebook)
    document.cookie = `_fbp=${fbp}; max-age=7776000; path=/`;
    return fbp;
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å Facebook Click cookie (_fbc)
   * –°–æ–∑–¥–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ Facebook —Ä–µ–∫–ª–∞–º–µ
   * –§–æ—Ä–º–∞—Ç: fb.1.{timestamp}.{fbclid}
   * –í–ê–ñ–ù–û: –†–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è fbclid –ò –¥–ª—è brid –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤!
   */
  function getFacebookClickCookie() {
    const cookies = document.cookie.split('; ');
    for (let cookie of cookies) {
      if (cookie.startsWith('_fbc=')) {
        return cookie.substring(5);
      }
    }

    // –ï—Å–ª–∏ _fbc –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ –∏–∑ fbclid –ò–õ–ò brid
    const urlParams = new URLSearchParams(window.location.search);
    const fbclid = urlParams.get('fbclid');
    const brid = urlParams.get('brid');
    const trackingId = fbclid || brid;  // –ë–µ—Ä–µ–º –ª—é–±–æ–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä

    if (trackingId) {
      const fbc = `fb.2.${Date.now()}.${trackingId}`;  // fb.2 –¥–ª—è fbc (–Ω–µ fb.1!)
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º cookie –Ω–∞ 90 –¥–Ω–µ–π (—Å—Ç–∞–Ω–¥–∞—Ä—Ç Facebook)
      document.cookie = `_fbc=${fbc}; max-age=7776000; path=/`;
      return fbc;
    }

    return null;
  }

  /**
   * –°–æ–±—Ä–∞—Ç—å –≤—Å–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä–∞
   */
  function collectBrowserMetadata() {
    return {
      // User Agent
      user_agent: navigator.userAgent,

      // –Ø–∑—ã–∫
      language: navigator.language || navigator.userLanguage,
      languages: navigator.languages ? navigator.languages.join(',') : navigator.language,

      // Timezone
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      timezone_offset: new Date().getTimezoneOffset(),

      // Screen
      screen_width: window.screen.width,
      screen_height: window.screen.height,
      screen_available_width: window.screen.availWidth,
      screen_available_height: window.screen.availHeight,
      screen_color_depth: window.screen.colorDepth,
      screen_pixel_depth: window.screen.pixelDepth,

      // Viewport
      viewport_width: window.innerWidth,
      viewport_height: window.innerHeight,

      // Platform
      platform: navigator.platform,
      vendor: navigator.vendor,

      // Hardware
      device_memory: navigator.deviceMemory || null,
      cpu_cores: navigator.hardwareConcurrency || null,

      // Connection
      connection_type: navigator.connection ? navigator.connection.effectiveType : null,
      connection_downlink: navigator.connection ? navigator.connection.downlink : null,
      connection_rtt: navigator.connection ? navigator.connection.rtt : null,

      // Device detection
      is_mobile: /Mobile|Android|iPhone|iPad|iPod/i.test(navigator.userAgent),
      is_tablet: /iPad|Android.*Tablet/i.test(navigator.userAgent),
      is_desktop: !/Mobile|Android|iPhone|iPad|iPod/i.test(navigator.userAgent),
      is_touch: ('ontouchstart' in window) || (navigator.maxTouchPoints > 0),

      // Capabilities
      cookies_enabled: navigator.cookieEnabled,
      do_not_track: navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack || null
    };
  }

  /**
   * –°–æ–±—Ä–∞—Ç—å UTM –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
   */
  function collectUTMParameters() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
      utm_source: urlParams.get('utm_source'),
      utm_medium: urlParams.get('utm_medium'),
      utm_campaign: urlParams.get('utm_campaign'),
      utm_content: urlParams.get('utm_content'),
      utm_term: urlParams.get('utm_term'),
      utm_id: urlParams.get('utm_id'),

      // Ad platform tracking IDs
      gclid: urlParams.get('gclid'),  // Google
      ttclid: urlParams.get('ttclid'), // TikTok
      msclkid: urlParams.get('msclkid') // Bing
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å IP –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å fallback —á–µ—Ä–µ–∑ Promise.race)
   * –ó–∞–ø—É—Å–∫–∞–µ–º –í–°–ï API –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
   * –≠—Ç–æ –ë–´–°–¢–†–ï–ï —á–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏!
   */
  async function getClientIP() {
    const apis = [
      { url: 'https://api.ipify.org?format=json', parser: (d) => d.ip },
      { url: 'https://ipinfo.io/json', parser: (d) => d.ip },
      { url: 'https://api.ip.sb/jsonip', parser: (d) => d.ip }
    ];

    // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–∏—Å—ã –¥–ª—è –≤—Å–µ—Ö API
    const promises = apis.map(api =>
      fetch(api.url, { method: 'GET', cache: 'no-cache' })
        .then(r => {
          if (!r.ok) throw new Error('API failed');
          return r.json();
        })
        .then(data => {
          const ip = api.parser(data);
          if (!ip) throw new Error('No IP in response');
          return ip;
        })
    );

    try {
      // Promise.any - –±–µ—Ä–µ–º –ü–ï–†–í–´–ô —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
      const ip = await Promise.any(promises);
      return ip;
    } catch (error) {
      console.warn('All IP APIs failed:', error);
      return null;
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é —á–µ—Ä–µ–∑ IP (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
   */
  async function getGeoFromIP(ip) {
    if (!ip) return null;

    try {
      const response = await fetch(`https://ipapi.co/${ip}/json/`, {
        method: 'GET',
        cache: 'no-cache'
      });

      if (!response.ok) {
        throw new Error('Geo API failed');
      }

      const data = await response.json();
      return {
        country: data.country_name || null,
        country_code: data.country_code || null,
        city: data.city || null,
        region: data.region || null,
        postal_code: data.postal || null,
        latitude: data.latitude || null,
        longitude: data.longitude || null,
        timezone: data.timezone || null
      };
    } catch (error) {
      console.warn('Failed to get geo data:', error);
      return null;
    }
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å Performance –º–µ—Ç—Ä–∏–∫–∏
   * –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤–∞–ª–∏–¥–Ω—ã (–Ω–µ 0)
   */
  function getPerformanceMetrics() {
    if (!performance.timing) return {};

    const timing = performance.timing;
    const navStart = timing.navigationStart;

    return {
      // –ï—Å–ª–∏ loadEventEnd –µ—â–µ 0 (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null
      page_load_time: timing.loadEventEnd > 0 ? timing.loadEventEnd - navStart : null,
      dom_ready_time: timing.domContentLoadedEventEnd > 0 ? timing.domContentLoadedEventEnd - navStart : null,
      dns_time: timing.domainLookupEnd - timing.domainLookupStart,
      tcp_time: timing.connectEnd - timing.connectStart,
      request_time: timing.responseEnd - timing.requestStart,
      response_time: timing.responseEnd - timing.responseStart
    };
  }

  /**
   * –ü–æ–ª—É—á–∏—Ç—å URL –ø–∞—Ä–∞–º–µ—Ç—Ä
   */
  function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  }

  // ========== –í–†–ï–ú–Ø –ó–ê–ì–†–£–ó–ö–ò –°–¢–†–ê–ù–ò–¶–´ ==========
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º window —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –±—ã–ª–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ module script
  window.PAGE_LOAD_TIME = Date.now();
  </script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBBUjK-yQanZXKxLEW5HommyCA-94OfHz4",
      authDomain: "poker-fbclid.firebaseapp.com",
      databaseURL: "https://poker-fbclid-default-rtdb.firebaseio.com",
      projectId: "poker-fbclid",
      storageBucket: "poker-fbclid.firebasestorage.app",
      messagingSenderId: "267457868513",
      appId: "1:267457868513:web:8ad14b0bf0bfcb9aee7da0"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    /**
     * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ Firebase (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫)
     * –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é –≤–µ—Ç–∫—É errors/
     */
    function logError(errorType, errorMessage, extraData = {}) {
      // Fire and forget - –Ω–µ –∂–¥–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
      const errorId = `${Date.now()}_${Math.random().toString(36).substr(2, 6)}`;
      set(ref(database, `fishflash_errors/${errorId}`), {
        error_type: errorType,
        error_message: errorMessage,
        timestamp: Date.now(),
        timestamp_readable: new Date().toISOString(),
        url: window.location.href,
        user_agent: navigator.userAgent,
        ...extraData
      }).catch(() => {}); // –ú–æ–ª—á–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
    }

    function generateShortId() {
      return Math.random().toString(36).substring(2, 10);
    }

    /**
     * –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–•
     * –°–æ–±–∏—Ä–∞–µ—Ç –º–∞–∫—Å–∏–º—É–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è EMQ
     */
    async function saveFbclid(shortId, trackingId, paramType) {
      try {
        const timestamp = Date.now();

        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        const [browserData, utmData, ipAddress, performanceData] = await Promise.all([
          Promise.resolve(collectBrowserMetadata()),
          Promise.resolve(collectUTMParameters()),
          getClientIP().catch(() => null),
          Promise.resolve(getPerformanceMetrics())
        ]);

        // –ü–æ–ª—É—á–∞–µ–º geo –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å IP (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        let geoData = null;
        if (ipAddress) {
          geoData = await getGeoFromIP(ipAddress).catch(() => null);
        }

        // –ü–æ–ª—É—á–∞–µ–º Facebook cookies
        const fbc = getFacebookClickCookie();
        const fbp = getFacebookBrowserPixel();

        // –ö–†–ò–¢–ò–ß–ù–û: –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π fbclid —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º timestamp
        // –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è fbclid –ò brid - –æ–±–∞ –Ω—É–∂–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ
        const fullFbclid = `fb.1.${timestamp}.${trackingId}`;

        // –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è Firebase
        const firebaseData = {
          // ========== –ö–†–ò–¢–ò–ß–ù–û –î–õ–Ø EMQ ==========
          fbclid: fullFbclid,
          fbclid_original: trackingId,
          parameter_type: paramType,

          // Facebook Cookies (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û!)
          fbc: fbc,
          fbp: fbp,

          // ========== TIMESTAMPS ==========
          timestamp: timestamp,
          timestamp_readable: new Date().toISOString(),

          // ========== URLs ==========
          url: window.location.href,
          referrer: document.referrer || 'direct',

          // ========== UTM PARAMETERS ==========
          utm_source: utmData.utm_source,
          utm_medium: utmData.utm_medium,
          utm_campaign: utmData.utm_campaign,
          utm_content: utmData.utm_content,
          utm_term: utmData.utm_term,
          utm_id: utmData.utm_id,

          // Ad platforms
          gclid: utmData.gclid,
          ttclid: utmData.ttclid,
          msclkid: utmData.msclkid,

          // ========== BROWSER DATA ==========
          user_agent: browserData.user_agent,
          language: browserData.language,
          languages: browserData.languages,
          timezone: browserData.timezone,
          timezone_offset: browserData.timezone_offset,

          // ========== DEVICE INFO ==========
          platform: browserData.platform,
          vendor: browserData.vendor,
          device_type: browserData.is_mobile ? 'mobile' : (browserData.is_tablet ? 'tablet' : 'desktop'),
          is_mobile: browserData.is_mobile,
          is_tablet: browserData.is_tablet,
          is_desktop: browserData.is_desktop,
          is_touch: browserData.is_touch,

          // Hardware
          device_memory: browserData.device_memory,
          cpu_cores: browserData.cpu_cores,

          // ========== SCREEN ==========
          screen_width: browserData.screen_width,
          screen_height: browserData.screen_height,
          screen_available_width: browserData.screen_available_width,
          screen_available_height: browserData.screen_available_height,
          color_depth: browserData.screen_color_depth,
          pixel_depth: browserData.screen_pixel_depth,
          viewport_width: browserData.viewport_width,
          viewport_height: browserData.viewport_height,

          // ========== CONNECTION ==========
          connection_type: browserData.connection_type,
          connection_downlink: browserData.connection_downlink,
          connection_rtt: browserData.connection_rtt,

          // ========== CAPABILITIES ==========
          cookies_enabled: browserData.cookies_enabled,
          do_not_track: browserData.do_not_track,

          // ========== IP & GEO (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã) ==========
          // –í–ê–ñ–ù–û: Firebase –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç undefined, –∏—Å–ø–æ–ª—å–∑—É–µ–º null
          ip_address: ipAddress ?? null,
          country: geoData?.country ?? null,
          country_code: geoData?.country_code ?? null,
          city: geoData?.city ?? null,
          region: geoData?.region ?? null,
          postal_code: geoData?.postal_code ?? null,
          geo_latitude: geoData?.latitude ?? null,
          geo_longitude: geoData?.longitude ?? null,
          geo_timezone: geoData?.timezone ?? null,

          // ========== PERFORMANCE ==========
          // –í–ê–ñ–ù–û: Firebase –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç undefined, –∏—Å–ø–æ–ª—å–∑—É–µ–º null
          page_load_time: performanceData.page_load_time ?? null,
          dom_ready_time: performanceData.dom_ready_time ?? null,
          dns_time: performanceData.dns_time ?? null,
          tcp_time: performanceData.tcp_time ?? null,
          request_time: performanceData.request_time ?? null,
          response_time: performanceData.response_time ?? null,

          // ========== STATE ==========
          button_clicked: false,
          page_visible: !document.hidden,
          has_focus: document.hasFocus()
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase —Å timeout (–û–¢–î–ï–õ–¨–ù–ê–Ø –í–ï–¢–ö–ê –î–õ–Ø FISHFLASH!)
        const savePromise = set(ref(database, `fishflash_fbclids/${shortId}`), firebaseData);
        const timeoutPromise = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Firebase timeout')), 5000)
        );

        await Promise.race([savePromise, timeoutPromise]);

        console.log('‚úÖ Successfully saved to Firebase (FishFlash):', {
          shortId: shortId,
          fullFbclid: fullFbclid,
          fbc: fbc,
          fbp: fbp,
          ipAddress: ipAddress,
          geo: geoData ? `${geoData.city}, ${geoData.country}` : 'unavailable'
        });

        return true;
      } catch (error) {
        console.error('‚ùå Error saving to Firebase:', error);
        logError('firebase_save', error.message, { short_id: shortId, tracking_id: trackingId });
        return false;
      }
    }

    async function trackButtonClick(shortId, telegramLink) {
      try {
        const startMatch = telegramLink.match(/\?start=([^&]+)/);
        const startParameter = startMatch ? startMatch[1] : 'NO_START_PARAM';
        const linkMatches = (startParameter === shortId);

        // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const timeOnPageMs = Date.now() - PAGE_LOAD_TIME;
        const timeOnPageSeconds = Math.round(timeOnPageMs / 1000);

        await update(ref(database, `fishflash_fbclids/${shortId}`), {
          button_clicked: true,
          click_time: Date.now(),
          click_time_readable: new Date().toISOString(),
          telegram_link: telegramLink,
          start_parameter: startParameter,
          link_matches: linkMatches,
          time_on_page_ms: timeOnPageMs,
          time_on_page_seconds: timeOnPageSeconds
        });
        return true;
      } catch (error) {
        console.error('Error tracking button click:', error);
        logError('button_click', error.message, { short_id: shortId });
        return false;
      }
    }

    // Lead —Å–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ –±–æ—Ç (Conversions API),
    // –∞ –Ω–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫–ª–∞–¥–∫—É, –ø–æ—ç—Ç–æ–º—É sendLeadEvent() —É–¥–∞–ª–µ–Ω

    // ========== MAIN LOGIC ==========

    const fbclid = getUrlParameter('fbclid');
    const brid = getUrlParameter('brid');
    const trackingId = fbclid || brid;
    const parameterType = fbclid ? 'fbclid' : (brid ? 'brid' : 'none');

    const button = document.getElementById('telegramButton');
    const loading = document.getElementById('loading');
    const fullUrl = window.location.href;
    const timestamp = new Date().toISOString();

    let currentShortId = null;

    if (trackingId) {
      // –ë–õ–û–ö–ò–†–£–ï–ú –∫–Ω–æ–ø–∫—É –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
      button.style.pointerEvents = 'none';
      button.style.opacity = '0.5';

      loading.style.display = 'block';
      loading.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';

      const shortId = generateShortId();
      currentShortId = shortId;

      button.href = `https://t.me/FishFlashClub_bot?start=${shortId}`;

      if (typeof fbq !== 'undefined') {
        fbq('trackCustom', 'ProkladkaWithFbclid', {
          tracking_id: trackingId,
          parameter_type: parameterType,
          fbclid_short: shortId,
          tracking_id_length: trackingId.length,
          full_url: fullUrl,
          referrer: document.referrer || 'direct',
          timestamp: timestamp
        });
      }

      saveFbclid(shortId, trackingId, parameterType).then((success) => {
        // –†–ê–ó–ë–õ–û–ö–ò–†–£–ï–ú –∫–Ω–æ–ø–∫—É –ü–û–°–õ–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        button.style.pointerEvents = 'auto';
        button.style.opacity = '1';

        // –°—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        loading.style.display = 'none';
      });
    } else {
      button.href = 'https://t.me/FishFlashClub_bot?start=NOFBCLID';

      if (typeof fbq !== 'undefined') {
        fbq('trackCustom', 'ProkladkaWithoutFbclid', {
          full_url: fullUrl,
          referrer: document.referrer || 'direct',
          timestamp: timestamp,
          reason: 'tracking_id_missing'
        });
      }
    }

    button.addEventListener('click', function(e) {
      // Lead —Å–æ–±—ã—Ç–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —á–µ—Ä–µ–∑ –±–æ—Ç –ø—Ä–∏ /start
      if (currentShortId) {
        trackButtonClick(currentShortId, button.href);
      }
    });
  </script>
</body>
</html>
